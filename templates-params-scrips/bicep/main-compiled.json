{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "3166312993481862298"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "westus2",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "bookrblobst",
      "metadata": {
        "description": "Storage account name"
      }
    },
    "sqlServerName": {
      "type": "string",
      "defaultValue": "bookr-sql-server",
      "metadata": {
        "description": "SQL Server name"
      }
    },
    "sqlDatabaseName": {
      "type": "string",
      "defaultValue": "bookr-sql-db",
      "metadata": {
        "description": "SQL Database name"
      }
    },
    "sqlAdministratorLogin": {
      "type": "string",
      "defaultValue": "bookradmin",
      "metadata": {
        "description": "SQL Server administrator login"
      }
    },
    "sqlAdministratorPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Server administrator password"
      }
    },
    "staticWebAppName": {
      "type": "string",
      "defaultValue": "bookr-static-web-app",
      "metadata": {
        "description": "Static Web App name"
      }
    },
    "staticWebAppRepositoryUrl": {
      "type": "string",
      "defaultValue": "https://github.com/andrettiprz/bookr",
      "metadata": {
        "description": "Static Web App repository URL"
      }
    },
    "staticWebAppBranch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "Static Web App branch"
      }
    },
    "staticWebAppRepositoryToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Static Web App repository token (optional)"
      }
    },
    "functionAppName": {
      "type": "string",
      "defaultValue": "bookr-api",
      "metadata": {
        "description": "Function App name"
      }
    },
    "jwtSecret": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "JWT Secret for authentication"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storageDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "accountType": {
            "value": "Standard_LRS"
          },
          "kind": {
            "value": "StorageV2"
          },
          "minimumTlsVersion": {
            "value": "TLS1_2"
          },
          "supportsHttpsTrafficOnly": {
            "value": true
          },
          "allowBlobPublicAccess": {
            "value": false
          },
          "allowSharedKeyAccess": {
            "value": true
          },
          "defaultOAuth": {
            "value": false
          },
          "accessTier": {
            "value": "Hot"
          },
          "publicNetworkAccess": {
            "value": "Enabled"
          },
          "allowCrossTenantReplication": {
            "value": false
          },
          "networkAclsBypass": {
            "value": "AzureServices"
          },
          "networkAclsDefaultAction": {
            "value": "Allow"
          },
          "networkAclsIpRules": {
            "value": []
          },
          "networkAclsIpv6Rules": {
            "value": []
          },
          "publishIpv6Endpoint": {
            "value": false
          },
          "dnsEndpointType": {
            "value": "Standard"
          },
          "largeFileSharesState": {
            "value": "Enabled"
          },
          "keySource": {
            "value": "Microsoft.Storage"
          },
          "encryptionEnabled": {
            "value": true
          },
          "infrastructureEncryptionEnabled": {
            "value": false
          },
          "isBlobSoftDeleteEnabled": {
            "value": true
          },
          "blobSoftDeleteRetentionDays": {
            "value": 7
          },
          "isContainerSoftDeleteEnabled": {
            "value": true
          },
          "containerSoftDeleteRetentionDays": {
            "value": 7
          },
          "isShareSoftDeleteEnabled": {
            "value": true
          },
          "shareSoftDeleteRetentionDays": {
            "value": 7
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16717027840143858953"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "accountType": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "metadata": {
                "description": "Storage account type"
              }
            },
            "kind": {
              "type": "string",
              "defaultValue": "StorageV2",
              "metadata": {
                "description": "Storage account kind"
              }
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "TLS1_2",
              "metadata": {
                "description": "Minimum TLS version"
              }
            },
            "supportsHttpsTrafficOnly": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Supports HTTPS traffic only"
              }
            },
            "allowBlobPublicAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow blob public access"
              }
            },
            "allowSharedKeyAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Allow shared key access"
              }
            },
            "defaultOAuth": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Default OAuth authentication"
              }
            },
            "accessTier": {
              "type": "string",
              "defaultValue": "Hot",
              "metadata": {
                "description": "Access tier"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "metadata": {
                "description": "Public network access"
              }
            },
            "allowCrossTenantReplication": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow cross tenant replication"
              }
            },
            "networkAclsBypass": {
              "type": "string",
              "defaultValue": "AzureServices",
              "metadata": {
                "description": "Network ACLs bypass"
              }
            },
            "networkAclsDefaultAction": {
              "type": "string",
              "defaultValue": "Allow",
              "metadata": {
                "description": "Network ACLs default action"
              }
            },
            "networkAclsIpRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Network ACLs IP rules"
              }
            },
            "networkAclsIpv6Rules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Network ACLs IPv6 rules"
              }
            },
            "publishIpv6Endpoint": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Publish IPv6 endpoint"
              }
            },
            "dnsEndpointType": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "DNS endpoint type"
              }
            },
            "largeFileSharesState": {
              "type": "string",
              "defaultValue": "Enabled",
              "metadata": {
                "description": "Large file shares state"
              }
            },
            "keySource": {
              "type": "string",
              "defaultValue": "Microsoft.Storage",
              "metadata": {
                "description": "Key source for encryption"
              }
            },
            "encryptionEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Encryption enabled"
              }
            },
            "infrastructureEncryptionEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Infrastructure encryption enabled"
              }
            },
            "isBlobSoftDeleteEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Blob soft delete enabled"
              }
            },
            "blobSoftDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Blob soft delete retention days"
              }
            },
            "isContainerSoftDeleteEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Container soft delete enabled"
              }
            },
            "containerSoftDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Container soft delete retention days"
              }
            },
            "isShareSoftDeleteEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Share soft delete enabled"
              }
            },
            "shareSoftDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Share soft delete retention days"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2025-06-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "kind": "[parameters('kind')]",
              "sku": {
                "name": "[parameters('accountType')]"
              },
              "properties": {
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "supportsHttpsTrafficOnly": "[parameters('supportsHttpsTrafficOnly')]",
                "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                "allowSharedKeyAccess": "[parameters('allowSharedKeyAccess')]",
                "defaultToOAuthAuthentication": "[parameters('defaultOAuth')]",
                "accessTier": "[parameters('accessTier')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "allowCrossTenantReplication": "[parameters('allowCrossTenantReplication')]",
                "networkAcls": {
                  "bypass": "[parameters('networkAclsBypass')]",
                  "defaultAction": "[parameters('networkAclsDefaultAction')]",
                  "ipRules": "[parameters('networkAclsIpRules')]",
                  "ipv6Rules": "[parameters('networkAclsIpv6Rules')]"
                },
                "dualStackEndpointPreference": {
                  "publishIpv6Endpoint": "[parameters('publishIpv6Endpoint')]"
                },
                "dnsEndpointType": "[parameters('dnsEndpointType')]",
                "largeFileSharesState": "[parameters('largeFileSharesState')]",
                "encryption": {
                  "keySource": "[parameters('keySource')]",
                  "services": {
                    "blob": {
                      "enabled": "[parameters('encryptionEnabled')]"
                    },
                    "file": {
                      "enabled": "[parameters('encryptionEnabled')]"
                    },
                    "table": {
                      "enabled": "[parameters('encryptionEnabled')]"
                    },
                    "queue": {
                      "enabled": "[parameters('encryptionEnabled')]"
                    }
                  },
                  "requireInfrastructureEncryption": "[parameters('infrastructureEncryptionEnabled')]"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": "[parameters('isBlobSoftDeleteEnabled')]",
                  "days": "[parameters('blobSoftDeleteRetentionDays')]"
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": "[parameters('isContainerSoftDeleteEnabled')]",
                  "days": "[parameters('containerSoftDeleteRetentionDays')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "shareDeleteRetentionPolicy": {
                  "enabled": "[parameters('isShareSoftDeleteEnabled')]",
                  "days": "[parameters('shareSoftDeleteRetentionDays')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sqlServerDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "serverName": {
            "value": "[parameters('sqlServerName')]"
          },
          "databaseName": {
            "value": "[parameters('sqlDatabaseName')]"
          },
          "administratorLogin": {
            "value": "[parameters('sqlAdministratorLogin')]"
          },
          "administratorLoginPassword": {
            "value": "[parameters('sqlAdministratorPassword')]"
          },
          "collation": {
            "value": "SQL_Latin1_General_CP1_CI_AS"
          },
          "tier": {
            "value": "GeneralPurpose"
          },
          "skuName": {
            "value": "GP_S_Gen5_2"
          },
          "maxSizeBytes": {
            "value": 34359738368
          },
          "zoneRedundant": {
            "value": false
          },
          "licenseType": {
            "value": ""
          },
          "readScaleOut": {
            "value": "Disabled"
          },
          "numberOfReplicas": {
            "value": 0
          },
          "minCapacity": {
            "value": 1
          },
          "autoPauseDelay": {
            "value": 60
          },
          "allowAzureIps": {
            "value": false
          },
          "enableADS": {
            "value": false
          },
          "enableVA": {
            "value": false
          },
          "useVAManagedIdentity": {
            "value": false
          },
          "enableSqlLedger": {
            "value": false
          },
          "minimalTlsVersion": {
            "value": "1.2"
          },
          "publicNetworkAccess": {
            "value": "Disabled"
          },
          "connectionType": {
            "value": "Default"
          },
          "requestedBackupStorageRedundancy": {
            "value": "Local"
          },
          "availabilityZone": {
            "value": "NoPreference"
          },
          "useFreeLimit": {
            "value": true
          },
          "freeLimitExhaustionBehavior": {
            "value": "AutoPause"
          },
          "maintenanceConfigurationId": {
            "value": "[format('{0}/providers/Microsoft.Maintenance/publicMaintenanceConfigurations/SQL_Default', subscription().id)]"
          },
          "identity": {
            "value": {
              "type": "None"
            }
          },
          "primaryUserAssignedIdentityId": {
            "value": ""
          },
          "federatedClientId": {
            "value": ""
          },
          "databaseTags": {
            "value": {}
          },
          "serverTags": {
            "value": {}
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16652381433167580996"
            }
          },
          "parameters": {
            "administratorLogin": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "SQL Server administrator login"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "SQL Server administrator login password"
              }
            },
            "collation": {
              "type": "string",
              "defaultValue": "SQL_Latin1_General_CP1_CI_AS",
              "metadata": {
                "description": "Database collation"
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Database name"
              }
            },
            "tier": {
              "type": "string",
              "defaultValue": "GeneralPurpose",
              "metadata": {
                "description": "Database tier"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "GP_S_Gen5_2",
              "metadata": {
                "description": "Database SKU name"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "maxSizeBytes": {
              "type": "int",
              "defaultValue": 34359738368,
              "metadata": {
                "description": "Database max size in bytes"
              }
            },
            "serverName": {
              "type": "string",
              "metadata": {
                "description": "Server name"
              }
            },
            "sampleName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Sample name"
              }
            },
            "zoneRedundant": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Zone redundant"
              }
            },
            "licenseType": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "License type"
              }
            },
            "readScaleOut": {
              "type": "string",
              "defaultValue": "Disabled",
              "metadata": {
                "description": "Read scale out"
              }
            },
            "numberOfReplicas": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "Number of replicas"
              }
            },
            "minCapacity": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "Min capacity (use 0 to disable)"
              }
            },
            "autoPauseDelay": {
              "type": "int",
              "defaultValue": 60,
              "metadata": {
                "description": "Auto pause delay in minutes"
              }
            },
            "allowAzureIps": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow Azure IPs"
              }
            },
            "databaseTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Database tags"
              }
            },
            "serverTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Server tags"
              }
            },
            "enableADS": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Advanced Data Security"
              }
            },
            "enableVA": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Vulnerability Assessment"
              }
            },
            "useVAManagedIdentity": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Use VA managed identity"
              }
            },
            "enableSqlLedger": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable SQL Ledger"
              }
            },
            "minimalTlsVersion": {
              "type": "string",
              "defaultValue": "1.2",
              "metadata": {
                "description": "Minimal TLS version"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Disabled",
              "metadata": {
                "description": "Public network access"
              }
            },
            "connectionType": {
              "type": "string",
              "defaultValue": "Default",
              "metadata": {
                "description": "Connection type"
              }
            },
            "requestedBackupStorageRedundancy": {
              "type": "string",
              "defaultValue": "Local",
              "metadata": {
                "description": "Requested backup storage redundancy"
              }
            },
            "availabilityZone": {
              "type": "string",
              "defaultValue": "NoPreference",
              "metadata": {
                "description": "Availability zone"
              }
            },
            "useFreeLimit": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Use free limit"
              }
            },
            "freeLimitExhaustionBehavior": {
              "type": "string",
              "defaultValue": "AutoPause",
              "metadata": {
                "description": "Free limit exhaustion behavior"
              }
            },
            "maintenanceConfigurationId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Maintenance configuration ID"
              }
            },
            "identity": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Identity"
              }
            },
            "primaryUserAssignedIdentityId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Primary user assigned identity ID"
              }
            },
            "federatedClientId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Federated client ID"
              }
            }
          },
          "variables": {
            "uniqueStorage": "[uniqueString(subscription().subscriptionId, resourceGroup().name, parameters('location'))]",
            "storageName": "[toLower(format('sqlva{0}', variables('uniqueStorage')))]"
          },
          "resources": [
            {
              "condition": "[and(parameters('enableVA'), not(parameters('useVAManagedIdentity')))]",
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2019-04-01",
              "name": "[variables('storageName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false
              }
            },
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2021-05-01-preview",
              "name": "[parameters('serverName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('serverTags')]",
              "properties": {
                "version": "12.0",
                "minimalTlsVersion": "[parameters('minimalTlsVersion')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[if(not(equals(parameters('administratorLoginPassword'), '')), parameters('administratorLoginPassword'), null())]",
                "primaryUserAssignedIdentityId": "[if(not(equals(parameters('primaryUserAssignedIdentityId'), '')), parameters('primaryUserAssignedIdentityId'), null())]",
                "federatedClientId": "[if(not(equals(parameters('federatedClientId'), '')), parameters('federatedClientId'), null())]"
              },
              "identity": "[parameters('identity')]"
            },
            {
              "type": "Microsoft.Sql/servers/connectionPolicies",
              "apiVersion": "2021-08-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), 'Default')]",
              "properties": {
                "connectionType": "[parameters('connectionType')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), parameters('databaseName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('databaseTags')]",
              "properties": {
                "collation": "[parameters('collation')]",
                "maxSizeBytes": "[parameters('maxSizeBytes')]",
                "sampleName": "[if(not(equals(parameters('sampleName'), '')), parameters('sampleName'), null())]",
                "zoneRedundant": "[parameters('zoneRedundant')]",
                "licenseType": "[if(not(equals(parameters('licenseType'), '')), parameters('licenseType'), null())]",
                "readScale": "[parameters('readScaleOut')]",
                "highAvailabilityReplicaCount": "[parameters('numberOfReplicas')]",
                "minCapacity": "[if(greater(parameters('minCapacity'), 0), parameters('minCapacity'), null())]",
                "autoPauseDelay": "[parameters('autoPauseDelay')]",
                "requestedBackupStorageRedundancy": "[parameters('requestedBackupStorageRedundancy')]",
                "isLedgerOn": "[parameters('enableSqlLedger')]",
                "availabilityZone": "[parameters('availabilityZone')]",
                "useFreeLimit": "[parameters('useFreeLimit')]",
                "freeLimitExhaustionBehavior": "[if(not(equals(parameters('freeLimitExhaustionBehavior'), '')), parameters('freeLimitExhaustionBehavior'), null())]",
                "maintenanceConfigurationId": "[if(not(equals(parameters('maintenanceConfigurationId'), '')), parameters('maintenanceConfigurationId'), null())]"
              },
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('tier')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers/connectionPolicies', parameters('serverName'), 'Default')]",
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "condition": "[parameters('allowAzureIps')]",
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2021-11-01",
              "name": "[format('{0}/{1}', parameters('serverName'), 'AllowAllWindowsAzureIps')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "condition": "[parameters('enableADS')]",
              "type": "Microsoft.Sql/servers/advancedThreatProtectionSettings",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), 'Default')]",
              "properties": {
                "state": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers/databases', parameters('serverName'), parameters('databaseName'))]",
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "condition": "[and(parameters('enableVA'), not(parameters('useVAManagedIdentity')))]",
              "type": "Microsoft.Sql/servers/vulnerabilityAssessments",
              "apiVersion": "2018-06-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), 'Default')]",
              "properties": {
                "storageContainerPath": "[format('{0}vulnerability-assessment', reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageName')), '2019-04-01').primaryEndpoints.blob)]",
                "storageAccountAccessKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageName')), '2019-04-01').keys[0].value]",
                "recurringScans": {
                  "isEnabled": true,
                  "emailSubscriptionAdmins": false,
                  "emails": []
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers/advancedThreatProtectionSettings', parameters('serverName'), 'Default')]",
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName'))]"
              ]
            }
          ],
          "outputs": {
            "sqlServerName": {
              "type": "string",
              "value": "[parameters('serverName')]"
            },
            "sqlServerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            },
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('serverName'), parameters('databaseName'))]"
            },
            "sqlServerFqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Sql/servers', parameters('serverName')), '2021-05-01-preview').fullyQualifiedDomainName]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "staticWebAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('staticWebAppName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "Free"
          },
          "skuCode": {
            "value": "Free"
          },
          "repositoryUrl": {
            "value": "[parameters('staticWebAppRepositoryUrl')]"
          },
          "branch": {
            "value": "[parameters('staticWebAppBranch')]"
          },
          "repositoryToken": {
            "value": "[parameters('staticWebAppRepositoryToken')]"
          },
          "appLocation": {
            "value": "./frontend"
          },
          "apiLocation": {
            "value": ""
          },
          "appArtifactLocation": {
            "value": "dist"
          },
          "enterpriseGradeCdnStatus": {
            "value": "disabled"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12769764084650963116"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Static Web App name"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the Static Web App"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Free",
              "metadata": {
                "description": "SKU tier"
              }
            },
            "skuCode": {
              "type": "string",
              "defaultValue": "Free",
              "metadata": {
                "description": "SKU code"
              }
            },
            "repositoryUrl": {
              "type": "string",
              "metadata": {
                "description": "Repository URL"
              }
            },
            "branch": {
              "type": "string",
              "defaultValue": "main",
              "metadata": {
                "description": "Branch name"
              }
            },
            "repositoryToken": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Repository token"
              }
            },
            "appLocation": {
              "type": "string",
              "defaultValue": "./frontend",
              "metadata": {
                "description": "App location"
              }
            },
            "apiLocation": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "API location"
              }
            },
            "appArtifactLocation": {
              "type": "string",
              "defaultValue": "dist",
              "metadata": {
                "description": "App artifact location"
              }
            },
            "enterpriseGradeCdnStatus": {
              "type": "string",
              "defaultValue": "disabled",
              "metadata": {
                "description": "Enterprise grade CDN status"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2022-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "repositoryUrl": "[parameters('repositoryUrl')]",
                "branch": "[parameters('branch')]",
                "repositoryToken": "[if(not(equals(parameters('repositoryToken'), '')), parameters('repositoryToken'), null())]",
                "buildProperties": {
                  "appLocation": "[parameters('appLocation')]",
                  "apiLocation": "[if(not(equals(parameters('apiLocation'), '')), parameters('apiLocation'), null())]",
                  "appArtifactLocation": "[parameters('appArtifactLocation')]"
                },
                "enterpriseGradeCdnStatus": "[parameters('enterpriseGradeCdnStatus')]"
              },
              "sku": {
                "tier": "[parameters('sku')]",
                "name": "[parameters('skuCode')]"
              }
            }
          ],
          "outputs": {
            "staticWebAppName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "staticWebAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/staticSites', parameters('name'))]"
            },
            "defaultHostname": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/staticSites', parameters('name')), '2022-09-01').defaultHostname]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[parameters('functionAppName')]"
          },
          "appServicePlanId": {
            "value": ""
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sqlServerFqdn": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment'), '2025-04-01').outputs.sqlServerFqdn.value]"
          },
          "sqlDatabaseName": {
            "value": "[parameters('sqlDatabaseName')]"
          },
          "sqlUser": {
            "value": "[parameters('sqlAdministratorLogin')]"
          },
          "sqlPassword": {
            "value": "[parameters('sqlAdministratorPassword')]"
          },
          "storageConnectionString": {
            "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix=core.windows.net', reference(resourceId('Microsoft.Resources/deployments', 'storageDeployment'), '2025-04-01').outputs.storageAccountName.value)]"
          },
          "jwtSecret": "[if(not(equals(parameters('jwtSecret'), '')), createObject('value', parameters('jwtSecret')), createObject('value', format('bookr-jwt-secret-change-in-production-{0}', uniqueString(resourceGroup().id))))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14496345260554802339"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "App Service Plan ID (leave empty for Consumption Plan)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the Function App"
              }
            },
            "sqlServerFqdn": {
              "type": "string",
              "metadata": {
                "description": "SQL Server FQDN"
              }
            },
            "sqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "SQL Database name"
              }
            },
            "sqlUser": {
              "type": "string",
              "metadata": {
                "description": "SQL User"
              }
            },
            "sqlPassword": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Password"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage account connection string"
              }
            },
            "jwtSecret": {
              "type": "securestring",
              "metadata": {
                "description": "JWT Secret"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-09-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp,linux",
              "properties": {
                "serverFarmId": "[if(not(equals(parameters('appServicePlanId'), '')), parameters('appServicePlanId'), '')]",
                "siteConfig": {
                  "use32BitWorkerProcess": false,
                  "alwaysOn": "[if(not(equals(parameters('appServicePlanId'), '')), true(), false())]",
                  "linuxFxVersion": "NODE|18",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[parameters('storageConnectionString')]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[parameters('storageConnectionString')]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(parameters('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "node"
                    },
                    {
                      "name": "SQL_SERVER",
                      "value": "[parameters('sqlServerFqdn')]"
                    },
                    {
                      "name": "SQL_DATABASE",
                      "value": "[parameters('sqlDatabaseName')]"
                    },
                    {
                      "name": "SQL_USER",
                      "value": "[parameters('sqlUser')]"
                    },
                    {
                      "name": "SQL_PASSWORD",
                      "value": "[parameters('sqlPassword')]"
                    },
                    {
                      "name": "AZURE_STORAGE_CONNECTION_STRING",
                      "value": "[parameters('storageConnectionString')]"
                    },
                    {
                      "name": "JWT_SECRET",
                      "value": "[parameters('jwtSecret')]"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~18"
                    }
                  ]
                },
                "httpsOnly": true
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2022-09-01').defaultHostName)]"
            },
            "functionAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storageDeployment')]"
      ]
    }
  ],
  "outputs": {
    "storageAccountName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeployment'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "storageAccountId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeployment'), '2025-04-01').outputs.storageAccountId.value]"
    },
    "sqlServerName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment'), '2025-04-01').outputs.sqlServerName.value]"
    },
    "sqlServerFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment'), '2025-04-01').outputs.sqlServerFqdn.value]"
    },
    "databaseName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment'), '2025-04-01').outputs.databaseName.value]"
    },
    "staticWebAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'staticWebAppDeployment'), '2025-04-01').outputs.staticWebAppName.value]"
    },
    "staticWebAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'staticWebAppDeployment'), '2025-04-01').outputs.defaultHostname.value]"
    },
    "functionAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionAppDeployment'), '2025-04-01').outputs.functionAppName.value]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionAppDeployment'), '2025-04-01').outputs.functionAppUrl.value]"
    }
  }
}